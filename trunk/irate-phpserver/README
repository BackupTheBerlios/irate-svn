*********
Crash Course
***************************


What is this ? => iRATE PHP server v0.2 "Anaella"

Which license ? => GPL licensed, baby

Who wrote it ? => jamendo.com (nice place for free music)



***
Intro
**************************

This is an iRATE server written in PHP.

It implements a new HTTP/XMLRPC protocol for iRATE, as well as new
SQL backend.




*********
Installation
***************************************

You basically need an Apache+PHP4 server, and some SQL database.

Currently, we only tested it with MySQL, but it should work
with other databases as well.

You need to create a database, and import the database scheme in 
the file setup.sql. To do so, you have to do somethin like :

irate-phpserver/# mysql -u root -p
password:
> create database irate;
> use irate;
> source setup.sql;
> exit;


Then you'll need to install some PEAR PHP modules :

# pear install -o XML_RPC DB


Copy config.php.SAMPLE to config.php

Then edit config.php, and fix the DSN with your database password.

You need to put your irate-phpserver somewhere in your apache webroot.
Additionally, you should have an apache vhost linked to the
irate-phpserver directory, so that the URL of the server is simple.


Then log in as admin to create the admin account.





******
Quick FAQ
*************************

 - A server written in PHP ? WTF ?!

We'll most likely end up rewritting this code in C/C++ in the next
few years, but for the moment, writting it in PHP makes sense, 
maybe more for Apache than for PHP. Performance issues will be
mostly SQL related, and Apache will help with scalability. We also
would like many people to test new correlation algorithms, and
PHP is very easy to learn and use ; anyway most of the hard stuff
will be SQL-related.

 - Why a new HTTP protocol ?

To allow people behind a firewall to use iRATE. XMLRPC will
also allow third-party iRATE clients to be easily developed.





**********
The Protocol
*************************

Actually communicating with the iRATE server is very easy :
It's XML-RPC (www.xmlrpc.org). There are libraries for
almost every language out there, so we'll hopefully see
new irate-enabled software, websites, whatever.

A pseudo-code client is included at the end of the README.


Here are the main things you can do with irate-phpserver :


* Connecting
------------

Just connect to the host where the irate-phpserver is installed.

For instance : 
 server : localhost ; path : myprojects/irate-phpserver/

The port is 80.


* Registering
-------------

Of course, registering doesn't need auth. (so don't include ?u=...&h=.... in the address
for this query, see "Logging in")

XMLRPC function : irate.register
XMLRPC params : 
 * struct 
    - username => .....  (irate username)
    - password => .....  (clear password)


The function will return "OK" or an error.



* Logging in
------------

The login isn't done via xmlrpc to simplify the protocol.

You have to send the username and a hash of the password.

The hash is : sha1( "irate" . sha1 ( $password ) );

So to connect to irate server, just query the XMLRPC location :

  localhost/myprojects/irate-phpserver/?u=[username]&h=[sha1_hash]

If the login failed, an XMLRPC error will be thrown.

All of the XMLRPC queries have to include these credentials in
the path of the XMLRPC interface.




* Asking for new tracks
-----------------------



XMLRPC function : irate.getNew
XMLRPC params :
 * struct
    - n => 6      (the number of new tracks you want)


The function will return an array of new tracks, with a
struct for each one, describing it and where it can be downloaded.



[TODO example of struct return]





So we have 3 hierarchical things : track, distribution and source.

- Fields for a track

* id : 

This is a custom LDBID (http://www.libredb.org/).

iRATE servers can have two kinds of files. The ones that come
from LibreDB, and the other, server-specific ones.

For LibreDB files, The ID will be [LDBID]-0

For the others, the ID will be XXXXXXX-YYY-ZZ-1 (same scheme
as LDBIDs, but it's the irate server admin who gives
these IDs.)

* artistname : string
* albumname : string
* trackname : string
* duration : int (length in seconds)
* license
* crediturl : string

- Fields for a distribution

* crediturl : string
* codec : string (http://www.matroska.org/technical/specs/codecid/)
* hash_sha1 : string(40)
* filesize : int

- Fields for a source

* protocol : string (eg. "http" or "bittorrent" or whatever)
* link : string
* crediturl : string


The shown crediturl should be the first available from source, distribution and then track.



* Rating tracks
---------------

You can rate multiple track with only one XMLRPC query.

XMLRPC function : irate.rate
XMLRPC params :
 * array
    - {rating 1}
    - {rating 2}
    - etc....

Each {rating X} is a struct with the following elements :
 - rating => integer (0-10)
 - weight => double (0-1), defaults to 1
 - id => irate ID of the track (optional)
 - hash_sha1 => sha1 hash of the track (optional)
 - protocol => string (http, bittorrent,...) (optional)
 - link => string (where the track was downloaded : http://www.iuma.com/mp3/...) (optional)


Please note that id,hash_sha1,protocol and link are needed
to identify the track you're rating.

id SHOULD be given if you have it.

If you don't (iRATE <0.4 clients), the advice is to send
 protocol="http" and link="http://..."




* Unrating tracks
-----------------

You can unset ratings you've done previously.

XMLRPC function : irate.unrate
XMLRPC params :
 * array
  - {rating 1}
  - {rating 2}
  - etc....

each {rating} is the same as before with irate.rate, but of course
"rating" and "weight" are not to be set.




* Getting all the ratings back to the client
--------------------------------------------


TBC





---- Outdated past this ----


Client : GET http://../&u=myuser&h=HASH&do=getratings

"do=getratings" : the client asks for its previous ratings

Server replies : 
(HTTP Headers)

<ratings>XX:6,YY:3</ratings>

The client had previously done 2 ratings : it rated the track with ID XX to 6/10, and the track YY to 3/10


* Errors
--------

At any time, the server can return an error like this :

Server reply :

<error>ERROR_CODE</error>

The error codes can be :
* WRONG_PASSWORD : The password doesn't match for the user.
* MUST_LOGIN : The username or the password wasn't given



* Admin actions
---------------

The user named "admin" is the admin of the server (not kidding)

You must set a password for this user when setting up your
server, logging in with "?u=admin&p=new_admin_password", at
the very beginning.

Then what you can do is :

 - Grab all new tracks from LibreDB :
   "?u=admin&p=...&do=admin&action=grab&grab=libredb_audio1"




* Migrating from old irate (dev only !)
---------------------------------------

Get a track ID from a http url :
 - "?u=..&p=..&do=OLD_url2id&url=http://artist.iuma.com/..."

Migration steps :

 1. server: Import user database
 2. server: Export all tracks to libredb and them import them from libredb to irate (they have IDs now)
 3. client: Make the new client ask for IDs. (see above)
 4. client: Make the client send again all his ratings with
 appropriate IDs
 5. client: Move files,database,... to the new scheme






****
What's next ?
************************

That's all folks, if you have any ideas/comments/suggestions/... ,
feel free to contact the right man, that's to say :

 * ajones@users.sourceforge.net : for iRATE related stuff
 * irate@jamendo.com : For iRATE-phpserver specific stuff
 * root@localhost : For personal stuff.


Ok, EOF :)
